<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>당신의 소설 어시스턴트</title>
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <!-- header -->
    <header>
      <h1>당신의 소설 어시스턴트</h1>
    </header>
    <!-- //header -->
    <!-- main -->
    <div class="main">
      <!-- 새로고침 버튼 -->
      <span style="float: right">
        <a onClick="window.location.reload()" style="cursor: pointer">
          <i class="fa-solid fa-arrows-rotate"></i> </a
      ></span>
      <!-- //새로고침 버튼 -->
      <!-- 소재 장르 파트 -->
      <div class="container">
        <ul class="plotContainer"></ul>
        <div class="inputArea">
          <form>
            <input type="text" id="topicInput" placeholder="소재" />
            <input type="text" id="genreInput" placeholder="장르" />
            <button type="submit">입력</button>
          </form>
          <div id="inputText"></div>
        </div>
      </div>
      <!-- //소재 장르 파트 -->
      <div class="detailContainer">
        <button id="characterButton" disabled>등장인물</button>
        <div class="characterSector">
          <ul id="characterContainer1"></ul>
          <ul id="characterContainer2"></ul>
        </div>
        <div class="happeningSector">
          <button id="happeningButton" disabled>에피소드</button>
          <ul id="happeningContainer"></ul>
        </div>
      </div>
      <!-- 모달 -->
      <div id="modal" class="modal">
        <div class="modalContent">
          <span class="close">&times;</span>
          <p id="modalText"></p>
        </div>
      </div>
      <!-- //모달 -->
    </div>
    <!-- //main -->
    <!-- footer -->
    <footer>
      <p>Copyright 2023. Bloodsteelrain. All rights reserved.</p>
    </footer>
    <!-- //footer -->

    <script>
      const $plotContainer = document.querySelector(".plotContainer");
      const $topicInput = document.querySelector("#topicInput");
      const $genreInput = document.querySelector("#genreInput");
      const $button = document.querySelector("button");
      const $inputText = document.querySelector("#inputText");
      const $characterButton = document.querySelector("#characterButton");
      const $happeningButton = document.querySelector("#happeningButton");
      const $characterSector = document.querySelector(".characterSector");
      const $characterContainer1 = document.querySelector(
        "#characterContainer1"
      );
      const $characterContainer2 = document.querySelector(
        "#characterContainer2"
      );
      const $happeningSector = document.querySelector(".happeningSector");
      const $happeningContainer = document.querySelector("#happeningContainer");
      const $modalContent = document.querySelector(".modalContent");

      // chatGPT API
      let url = `https://estsoft-openai-api.jejucodingcamp.workers.dev/`;

      // 사전 저장된 정보 (assistant의 역할)
      let data = [
        {
          role: "system",
          content:
            "assistant는 다양한 장르에 대한 지식과 이해를 기반으로 보조 작가 역할을 수행하는 소설가이다.",
        },
      ];

      // 입력 버튼 누를 시
      $button.addEventListener("click", (e) => {
        e.preventDefault();
        userInputTopic = $topicInput.value;
        $topicInput.value = "";
        userInputGenre = $genreInput.value;
        $genreInput.value = "";

        // 화면에 입력한 소재와 장르 표시
        let li1 = document.createElement("li");
        li1.innerText = `소재: ${userInputTopic}`;
        let li2 = document.createElement("li");
        li2.innerText = `장르: ${userInputGenre}`;
        $inputText.append(li1, li2);

        // data에 질문 추가
        data.push({
          role: "user",
          content: `소재: ${userInputTopic}, 장르: ${userInputGenre}의 소설 플롯 300자 내외로 작성해줘. 다음과 같은 형식으로 답변을 줘. 형식: '제목 : 작성한 제목\n설정 : 100자 이내의 작성한 내용의 배경 설정\n플롯 : 작성한 플롯 내용' `,
        });

        // modal을 띄우고 답변 표시
        openModal();
        Loading($modalContent);

        chatGptAPI(data, (answer) => {
          $characterButton.removeAttribute("disabled");
          // 화면에 답변 표시
          let li = document.createElement("li");
          li.innerText = answer;
          $plotContainer.appendChild(li);
          // 모달 텍스트 설정
          document.querySelector("#modalText").textContent = answer;
        });
      });

      // 등장인물 버튼 누를시
      $characterButton.addEventListener("click", (e) => {
        e.preventDefault();
        data.push({
          role: "user",
          content: `이 소설의 등장인물을 2명까지 세세하게 입체적으로 묘사해줘. 형식은 '등장인물1\n이름: 등장인물 이름\n등장인물 설명\n\n등장인물2\n이름: 등장인물 이름\n등장인물 설명\n' 으로 해줘`,
        });

        Loading($characterSector);

        chatGptAPI(data, (answer) => {
          $happeningButton.removeAttribute("disabled");
          // 화면에 답변 표시
          let li1 = document.createElement("li");
          li1.innerText = answer.split("\n\n")[0];
          $characterContainer1.appendChild(li1);

          let li2 = document.createElement("li");
          li2.innerText = answer.split("\n\n")[1];
          $characterContainer2.appendChild(li2);
          console.log(answer);
        });
      });

      // 에피소드 버튼 누를시
      $happeningButton.addEventListener("click", (e) => {
        e.preventDefault();
        data.push({
          role: "user",
          content: `이 소설에서 벌어지는 주요한 에피소드 하나를 300자 이내로 작성해줘`,
        });

        Loading($happeningSector);

        chatGptAPI(data, (answer) => {
          // 화면에 답변 표시
          let li = document.createElement("li");
          li.innerText = answer;
          $happeningContainer.appendChild(li);
        });
      });

      // chatGPT API에게 질문에 대한 답 요청
      function chatGptAPI(data, callback) {
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
          redirect: "follow",
        })
          .then((res) => res.json())
          .then((res) => {
            // console.log(res)
            // console.log(res.choices[0].message.content)
            let answer = res.choices[0].message.content;

            // 대화 데이터에 답변 추가
            data.push({
              role: "assistant",
              content: answer,
            });

            closeLoading();
            callback(answer);
          })
          .catch((error) => {
            console.error("Fetch 에러:", error);
            closeLoading();
            alert("데이터를 불러오는 데 실패했습니다");
          });
        // 아래 코드는 fetch 성공, 실패, 통신 중 여부와 상관없이 실행됩니다. 비동기에요.
        console.log("실행 확인");
      }

      // 답변 모달 열기
      function openModal() {
        // 모달 열기
        document.querySelector("#modal").style.display = "block";
        // 모달이 나타난 후에 모달 닫기 버튼에 이벤트 처리를 추가
        document.querySelector(".close").addEventListener("click", closeModal);
      }

      // 답변 모달 닫기
      function closeModal() {
        document.querySelector("#modal").style.display = "none";
      }

      // 로딩 이미지 생성
      function Loading(loadingLocation) {
        let loadingImg = document.createElement("div");
        loadingImg.id = "loadingImg";
        loadingImg.innerHTML = '<img src="/img/Spinner-1s-200px.gif">';
        // 로딩중 레이어 추가
        loadingLocation.appendChild(loadingImg);
        // 로딩중 이미지 표시
        loadingImg.style.display = "block";
      }

      // 로딩 이미지 숨기기
      function closeLoading() {
        document.querySelector("#loadingImg").remove();
      }
    </script>
  </body>
</html>
