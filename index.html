<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>당신의 소설 어시스턴트</title>
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div>
      <span style="float: right">
        <a onClick="window.location.reload()" style="cursor: pointer">
          <i class="fa-solid fa-arrows-rotate"></i> </a
      ></span>
      <div class="container">
        <ul class="plotContainer"></ul>
        <div class="inputArea">
          <form>
            <input type="text" id="topicInput" placeholder="소재" />
            <input type="text" id="genreInput" placeholder="장르" />
            <button type="submit">입력</button>
          </form>
          <div id="inputText"></div>
        </div>
      </div>
      <div class="detailContainer">
        <div class="characterSector">
          <button id="characterButton" disabled>등장인물</button>
          <ul id="characterContainer"></ul>
        </div>
        <div class="happeningSector">
          <button id="happeningButton" disabled>에피소드</button>
          <ul id="happeningContainer"></ul>
        </div>
      </div>
      <div id="loading">
        <i class="fa-solid fa-loader"></i>
        로딩 중입니다. 20 ~ 30초의 시간이 소요됩니다.
      </div>
    </div>
    <script>
      let $plotContainer = document.querySelector(".plotContainer");
      let $topicInput = document.querySelector("#topicInput");
      let $genreInput = document.querySelector("#genreInput");
      let $button = document.querySelector("button");
      let $inputText = document.querySelector("#inputText");
      let $characterButton = document.querySelector("#characterButton");
      let $happeningButton = document.querySelector("#happeningButton");
      let $characterContainer = document.querySelector("#characterContainer");
      let $happeningContainer = document.querySelector("#happeningContainer");

      // chatGPT API
      let url = `https://estsoft-openai-api.jejucodingcamp.workers.dev/`;

      // 사전 저장된 정보 (assistant의 역할)
      let data = [
        {
          role: "system",
          content:
            "assistant는 다양한 장르에 대한 지식과 이해를 기반으로 보조 작가 역할을 수행하는 소설가이다.",
        },
      ];

      // 입력 버튼 누를 시
      $button.addEventListener("click", (e) => {
        e.preventDefault();
        userInputTopic = $topicInput.value;
        $topicInput.value = "";
        userInputGenre = $genreInput.value;
        $genreInput.value = "";

        // 화면에 입력한 소재와 장르 표시
        let li1 = document.createElement("li");
        li1.innerText = `소재: ${userInputTopic}`;
        let li2 = document.createElement("li");
        li2.innerText = `장르: ${userInputGenre}`;
        $inputText.append(li1, li2);

        // data에 질문 추가
        data.push({
          role: "user",
          content: `소재: ${userInputTopic}, 장르: ${userInputGenre}의 소설 플롯 300자 내외로 작성해줘. 다음과 같은 형식으로 답변을 줘. 형식: '제목 : 작성한 제목\n설정 : 100자 이내의 작성한 내용의 배경 설정\n플롯 : 작성한 플롯 내용' `,
        });

        chatGptAPI(data, (answer) => {
          $characterButton.removeAttribute("disabled");
          // 화면에 답변 표시
          let li = document.createElement("li");
          li.innerText = answer;
          $plotContainer.appendChild(li);
        });
      });

      // 등장인물 버튼 누를시
      $characterButton.addEventListener("click", (e) => {
        e.preventDefault();
        data.push({
          role: "user",
          content: `이 소설의 등장인물을 2명까지 세세하게 입체적으로 묘사해줘`,
        });

        chatGptAPI(data, (answer) => {
          $happeningButton.removeAttribute("disabled");
          // 화면에 답변 표시
          let li = document.createElement("li");
          li.innerText = answer;
          $characterContainer.appendChild(li);
        });
      });

      // 에피소드 버튼 누를시
      $happeningButton.addEventListener("click", (e) => {
        e.preventDefault();
        data.push({
          role: "user",
          content: `이 소설에서 벌어지는 주요한 에피소드 하나를 300자 이내로 작성해줘`,
        });

        chatGptAPI(data, (answer) => {
          // 화면에 답변 표시
          let li = document.createElement("li");
          li.innerText = answer;
          $happeningContainer.appendChild(li);
        });
      });

      // chatGPT API에게 질문에 대한 답 요청
      function chatGptAPI(data, callback) {
        // 로딩 이미지 표시
        document.querySelector("#loading").style.display = "block";

        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
          redirect: "follow",
        })
          .then((res) => res.json())
          .then((res) => {
            // console.log(res)
            // console.log(res.choices[0].message.content)
            let answer = res.choices[0].message.content;

            // 대화 데이터에 답변 추가
            data.push({
              role: "assistant",
              content: answer,
            });
            // 로딩 이미지 숨김
            document.querySelector("#loading").style.display = "none";

            callback(answer);
          });
        // 아래 코드는 fetch 성공, 실패, 통신 중 여부와 상관없이 실행됩니다. 비동기에요.
        console.log("실행 확인");
      }
    </script>
  </body>
</html>
